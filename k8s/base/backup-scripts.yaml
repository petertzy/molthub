apiVersion: v1
kind: ConfigMap
metadata:
  name: backup-scripts
  namespace: moltbook
data:
  backup-postgres.sh: |
    #!/bin/bash
    set -e
    
    # Configuration
    BACKUP_DIR="/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="postgres_backup_${TIMESTAMP}.sql.gz"
    RETENTION_DAYS=7
    
    echo "Starting PostgreSQL backup at $(date)"
    
    # Create backup directory if it doesn't exist
    mkdir -p "$BACKUP_DIR"
    
    # Perform backup
    echo "Creating backup: $BACKUP_FILE"
    PGPASSWORD="$POSTGRES_PASSWORD" pg_dump \
      -h "$POSTGRES_HOST" \
      -U "$POSTGRES_USER" \
      -d "$POSTGRES_DB" \
      --format=plain \
      --no-owner \
      --no-acl \
      | gzip > "$BACKUP_DIR/$BACKUP_FILE"
    
    # Verify backup
    if [ -f "$BACKUP_DIR/$BACKUP_FILE" ]; then
      SIZE=$(du -h "$BACKUP_DIR/$BACKUP_FILE" | cut -f1)
      echo "Backup created successfully: $BACKUP_FILE (Size: $SIZE)"
    else
      echo "ERROR: Backup failed!"
      exit 1
    fi
    
    # Upload to S3 (if configured)
    if [ ! -z "$AWS_S3_BUCKET" ]; then
      echo "Uploading backup to S3..."
      aws s3 cp "$BACKUP_DIR/$BACKUP_FILE" "s3://$AWS_S3_BUCKET/backups/postgres/$BACKUP_FILE"
      echo "Upload complete"
    fi
    
    # Clean up old backups
    echo "Cleaning up backups older than $RETENTION_DAYS days..."
    find "$BACKUP_DIR" -name "postgres_backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete
    
    # List current backups
    echo "Current backups:"
    ls -lh "$BACKUP_DIR"
    
    echo "Backup completed at $(date)"
  
  backup-redis.sh: |
    #!/bin/bash
    set -e
    
    # Configuration
    BACKUP_DIR="/backups"
    TIMESTAMP=$(date +%Y%m%d_%H%M%S)
    BACKUP_FILE="redis_backup_${TIMESTAMP}.rdb"
    RETENTION_DAYS=7
    
    echo "Starting Redis backup at $(date)"
    
    # Create backup directory if it doesn't exist
    mkdir -p "$BACKUP_DIR"
    
    # Trigger Redis BGSAVE
    echo "Triggering Redis BGSAVE..."
    redis-cli -h "$REDIS_HOST" -a "$REDIS_PASSWORD" BGSAVE
    
    # Wait for BGSAVE to complete
    echo "Waiting for BGSAVE to complete..."
    INITIAL_SAVE=$(redis-cli -h "$REDIS_HOST" -a "$REDIS_PASSWORD" LASTSAVE)
    sleep 2
    
    MAX_WAIT=60
    WAITED=0
    while [ $WAITED -lt $MAX_WAIT ]; do
      CURRENT_SAVE=$(redis-cli -h "$REDIS_HOST" -a "$REDIS_PASSWORD" LASTSAVE)
      if [ "$CURRENT_SAVE" != "$INITIAL_SAVE" ]; then
        echo "BGSAVE completed"
        break
      fi
      sleep 2
      WAITED=$((WAITED + 2))
    done
    
    if [ $WAITED -ge $MAX_WAIT ]; then
      echo "WARNING: BGSAVE may not have completed within timeout"
    fi
    
    # Use redis-cli to save RDB file to backup location
    # Note: This requires the Redis data volume to be shared/accessible
    # Alternative: Use redis-cli --rdb to fetch RDB directly
    echo "Fetching RDB file using redis-cli..."
    redis-cli -h "$REDIS_HOST" -a "$REDIS_PASSWORD" --rdb "$BACKUP_DIR/$BACKUP_FILE"
    
    # Verify backup
    if [ -f "$BACKUP_DIR/$BACKUP_FILE" ]; then
      SIZE=$(du -h "$BACKUP_DIR/$BACKUP_FILE" | cut -f1)
      echo "Backup created successfully: $BACKUP_FILE (Size: $SIZE)"
    else
      echo "ERROR: Backup failed!"
      exit 1
    fi
    
    # Upload to S3 (if configured)
    if [ ! -z "$AWS_S3_BUCKET" ]; then
      echo "Uploading backup to S3..."
      aws s3 cp "$BACKUP_DIR/$BACKUP_FILE" "s3://$AWS_S3_BUCKET/backups/redis/$BACKUP_FILE"
      echo "Upload complete"
    fi
    
    # Clean up old backups
    echo "Cleaning up backups older than $RETENTION_DAYS days..."
    find "$BACKUP_DIR" -name "redis_backup_*.rdb" -mtime +$RETENTION_DAYS -delete
    
    echo "Backup completed at $(date)"
  
  restore-postgres.sh: |
    #!/bin/bash
    set -e
    
    if [ -z "$1" ]; then
      echo "Usage: $0 <backup_file>"
      echo "Available backups:"
      ls -lh /backups/postgres_backup_*.sql.gz 2>/dev/null || echo "No backups found"
      exit 1
    fi
    
    BACKUP_FILE="$1"
    
    echo "WARNING: This will restore the database from backup."
    echo "Backup file: $BACKUP_FILE"
    echo "Press Ctrl+C to cancel, or wait 10 seconds to continue..."
    sleep 10
    
    echo "Starting restore at $(date)"
    
    # Drop and recreate database
    echo "Recreating database..."
    PGPASSWORD="$POSTGRES_PASSWORD" psql -h "$POSTGRES_HOST" -U "$POSTGRES_USER" -d postgres <<-EOSQL
        DROP DATABASE IF EXISTS $POSTGRES_DB;
        CREATE DATABASE $POSTGRES_DB;
    EOSQL
    
    # Restore from backup
    echo "Restoring from backup..."
    gunzip -c "$BACKUP_FILE" | PGPASSWORD="$POSTGRES_PASSWORD" psql \
      -h "$POSTGRES_HOST" \
      -U "$POSTGRES_USER" \
      -d "$POSTGRES_DB"
    
    echo "Restore completed at $(date)"
    echo "Please verify the database integrity"
